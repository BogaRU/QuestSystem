# Используем официальный образ .NET SDK для сборки и тестирования
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build

WORKDIR /src

# Копируем файлы решений и проектов
COPY QuestSystem.sln .
COPY src/QuestSystem.Domain/QuestSystem.Domain.csproj src/QuestSystem.Domain/
COPY src/QuestSystem.Application/QuestSystem.Application.csproj src/QuestSystem.Application/
COPY src/QuestSystem.Infrastructure/QuestSystem.Infrastructure.csproj src/QuestSystem.Infrastructure/
COPY src/QuestSystem.API/QuestSystem.API.csproj src/QuestSystem.API/
COPY tests/QuestSystem.Domain.Tests/QuestSystem.Domain.Tests.csproj tests/QuestSystem.Domain.Tests/
COPY tests/QuestSystem.Application.Tests/QuestSystem.Application.Tests.csproj tests/QuestSystem.Application.Tests/

# Восстанавливаем зависимости
RUN dotnet restore

# Копируем весь код
COPY . .

# Сборка проекта без восстановления
RUN dotnet build --no-restore -c Release

# Запуск тестов
ENTRYPOINT ["dotnet", "test", "tests/QuestSystem.Domain.Tests/QuestSystem.Domain.Tests.csproj", "tests/QuestSystem.Application.Tests/QuestSystem.Application.Tests.csproj", "--logger:trx"]
